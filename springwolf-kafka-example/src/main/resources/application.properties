from __future__ import annotations
import boto3
from datetime import datetime
import logging

logger = logging.getLogger()
logger.setLevel(logging.INFO)

sagemaker_client = boto3.client("sagemaker")
securityhub_client = boto3.client('securityhub', region_name="us-east-1")  # Substitua pela sua região

def lambda_handler(event, context):
    print(event)

    # Extrai o ARN do domínio
    domain_arn = event['detail']['responseElements']['domainArn']
    domain_id = domain_arn.split('/')[-1]

    # Obtém as tags do domínio
    tags = sagemaker_client.list_tags(ResourceArn=domain_arn).get('Tags', [])

    # Verifica se a tag SagemakerException existe
    if any(tag['Key'] == 'SagemakerException' for tag in tags):
        print(f"Domain {domain_id} possui a tag SagemakerException. Nenhuma ação será realizada.")
        return

    # Obtém os detalhes do domínio para verificar o VPC
    domain_details = sagemaker_client.describe_domain(DomainId=domain_id)
    vpc_id = domain_details.get("VpcId")

    if vpc_id:
        print(f"Domain {domain_id} tem o VPC {vpc_id} associado.")
    else:
        print(f"Domain {domain_id} não tem VPC associado. Enviando finding para o Security Hub...")

        # Envia um finding para o Security Hub
        try:
            response = securityhub_client.batch_import_findings(
                Findings=[
                    {
                        'SchemaVersion': '2018-10-08',
                        'Id': f'{domain_id}/missing-vpc',
                        'ProductArn': f'arn:aws:securityhub:us-east-1:{event["account"]}:product/{event["account"]}/default',
                        'GeneratorId': 'sagemaker-domain-check',
                        'AwsAccountId': event['account'],
                        'Types': [
                            'Software and Configuration Checks/AWS Security Best Practices'
                        ],
                        'FirstObservedAt': datetime.utcnow().isoformat() + 'Z',
                        'CreatedAt': datetime.utcnow().isoformat() + 'Z',
                        'UpdatedAt': datetime.utcnow().isoformat() + 'Z',
                        'Severity': {
                            'Label': 'MEDIUM'
                        },
                        'Title': 'SageMaker Domain without VPC Association',
                        'Description': f'The SageMaker Domain {domain_id} does not have a VPC associated.',
                        'Resources': [
                            {
                                'Type': 'AwsSageMakerDomain',
                                'Id': domain_arn,
                                'Partition': 'aws',
                                'Region': "us-east-1",  # Substitua pela sua região
                                'Details': {
                                    'AwsSageMakerDomain': {
                                        'DomainName': domain_id
                                    }
                                }
                            }
                        ],
                        'SourceUrl': f'https://console.aws.amazon.com/sagemaker/home?region=us-east-1#/domains/{domain_id}/details',
                        'ProductFields': {
                            'Product Name': 'Custom SageMaker Remediation'
                        }
                    }
                ]
            )
            logger.info(f"Finding enviado para o Security Hub: {response}")
        except Exception as e:
            logger.error(f"Erro ao enviar finding para o Security Hub: {e}")

    return {
        'statusCode': 200,
        'body': f"Verificação concluída para o domínio {domain_id}."
    }
